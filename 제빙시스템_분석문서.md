# ICON-ICE-2KG 제빙 시스템 분석 문서

> **작성일**: 2025-12-31
> **프로젝트**: ICON-ICE-2KG 제빙기 (코웨이)
> **주요 파일**: `work_ice_make.c`, `work_flow.c`, `M8_Ice_Making.c`

---

## 목차

1. [ProcessIceMaking() 함수 동작 원리](#1-processicemaking-함수-동작-원리)
2. [이론 비율(Theory Ratio) 수식](#2-이론-비율theory-ratio-수식)
3. [제빙 STATE 흐름표](#3-제빙-state-흐름표)
4. [기술과제 핵심 요약](#4-기술과제-핵심-요약)

---

## 1. ProcessIceMaking() 함수 동작 원리

### 📌 함수 목적
제빙기에서 얼음을 만들 때 **실제 사용된 물량**을 분석하여, **다음 제빙 시간을 자동으로 조정**하는 **적응형 제어(Adaptive Control)** 함수입니다. 목표는 **70ml (7개 핑거 × 9g/핑거)**의 얼음을 만드는 것입니다.

### 위치
- 파일: `Source/Ice_Mini/work_ice_make.c`
- 라인: 75-164
- 호출: `M8_Ice_Making.c` STATE_42에서 호출

---

### 🔹 STEP 1: 변수 초기화 (라인 77-80)

```c
U16 mu16DeltaTimeLimit = 600;  // 1회 변화량 제한: 600초 (10분)
U8 count = 0;                   // 미사용 변수
U32 sum = 0;                    // 평균 계산용 합산 변수
U8 i = 0;                       // 루프 카운터
```

- **`mu16DeltaTimeLimit = 600`**: 제빙시간이 한 번에 10분(600초) 이상 급격히 변하지 않도록 제한
- 급격한 변화는 시스템 불안정을 야기할 수 있으므로 안정화 역할

---

### 🔹 STEP 2: 평균 유량 계산 (라인 82-111)

#### 2-1. 유효성 검사 (라인 82)
```c
if(GetDrainFlow() > 0)
```

**`GetDrainFlow()` 함수 역할:**
```c
// work_flow.c 63-73라인
F32 GetDrainFlow(void)
{
    if((DrainFlow.f32IceMakeBeforeFlowHz - DrainFlow.f32IceMakeAfterFlowHz) > 0)
    {
        return (DrainFlow.f32IceMakeBeforeFlowHz - DrainFlow.f32IceMakeAfterFlowHz);
    }
    else
    {
        return 0;
    }
}
```
- **제빙 전 유량 센서 값 - 제빙 후 유량 센서 값 = 실제 제빙에 사용된 물량 (Hz 단위)**
- 0보다 크면 정상, 0 이하면 센서 오류나 비정상 상황

---

#### 2-2. 초기 3회 데이터 수집 단계 (라인 86-96)

```c
if(IceAdjust.u8Cycle < 3)
{
    IceAdjust.f32IceMakeFlowHistory[IceAdjust.u8Cycle] = GetDrainFlow();
    IceAdjust.u8Cycle++;

    for(i = 0; i < IceAdjust.u8Cycle; i++)
    {
        sum += IceAdjust.f32IceMakeFlowHistory[i];
    }
    IceAdjust.f32IceMakeAvgFlow = (U16)(sum / IceAdjust.u8Cycle);
}
```

**동작:**
1. **첫 3회 제빙**까지는 히스토리 배열에 차례로 저장
2. **`u8Cycle`** 카운터 증가 (0 → 1 → 2 → 3)
3. 현재까지 수집된 데이터만 평균 계산
   - 1회차: 1개 평균
   - 2회차: 2개 평균
   - 3회차: 3개 평균

**예시:**
- 1회: History[0] = 100Hz → 평균 = 100Hz
- 2회: History[1] = 110Hz → 평균 = (100+110)/2 = 105Hz
- 3회: History[2] = 105Hz → 평균 = (100+110+105)/3 = 105Hz

---

#### 2-3. 4회차 이후 - FIFO 이동 평균 (라인 97-110)

```c
else
{
    // FIFO shift
    IceAdjust.f32IceMakeFlowHistory[0] = IceAdjust.f32IceMakeFlowHistory[1];
    IceAdjust.f32IceMakeFlowHistory[1] = IceAdjust.f32IceMakeFlowHistory[2];
    IceAdjust.f32IceMakeFlowHistory[2] = GetDrainFlow();

    // 3개 평균
    sum  = IceAdjust.f32IceMakeFlowHistory[0];
    sum += IceAdjust.f32IceMakeFlowHistory[1];
    sum += IceAdjust.f32IceMakeFlowHistory[2];

    IceAdjust.f32IceMakeAvgFlow = (sum / 3U);
}
```

**FIFO (First In First Out) 방식:**
- 가장 오래된 데이터[0]를 버리고, 모두 한 칸씩 앞으로 이동
- 새로운 데이터는 [2]에 저장
- **최근 3회 데이터만** 사용하여 이동 평균 계산

**예시:**
```
Before: [100, 110, 105]
After:  [110, 105, 120] ← 새로운 데이터 120 추가
평균 = (110 + 105 + 120) / 3 = 111.67Hz
```

**장점:** 최근 경향을 빠르게 반영, 오래된 데이터 영향 최소화

---

### 🔹 STEP 3: ZONE별 GAIN 설정 (라인 113-139)

이 부분은 **5개 ZONE**으로 나뉘어 있으며, 각 ZONE은 **제빙량에 따라 보정 강도**를 결정합니다.

#### 3-1. CC → Hz 변환
```c
#define C_ICE_MAKING 1.8F  // 1cc = 1.8Hz
```
- **120ml = 120 × 1.8 = 216Hz**
- **75ml = 75 × 1.8 = 135Hz**
- **50ml = 50 × 1.8 = 90Hz**
- **35ml = 35 × 1.8 = 63Hz**

---

#### 3-2. ZONE 분류 및 GAIN 값

| **ZONE** | **조건** | **제빙량** | **상태** | **GAIN** | **보정 방향** |
|----------|---------|----------|---------|---------|-------------|
| **ZONE 1** | `> 120ml` | 과다 | 심각 과제빙 | **0.7** | 강하게 줄이기 |
| **ZONE 2** | `75~120ml` | 약간 과다 | 살짝 과제빙 | **0.2** | 부드럽게 줄이기 |
| **ZONE 5** | `50~75ml` | **정상** | 목표 범위 | **0.05** | 살살 보정 (목표: 60~70ml) |
| **ZONE 3** | `35~50ml` | 약간 부족 | 살짝 부족 | **0.2** | 부드럽게 늘리기 |
| **ZONE 4** | `< 35ml` | 매우 부족 | 심각 부족 | **0.7** | 강하게 늘리기 |

**코드 분석:**

```c
// ZONE 1: 심각 과제빙
if(IceAdjust.f32IceMakeAvgFlow > GetCCToHz(120))  // > 216Hz
{
    SetGain(ZONE_1_GAIN);  // 0.7
}
// ZONE 2: 살짝 과제빙
else if(IceAdjust.f32IceMakeAvgFlow > GetCCToHz(75))  // > 135Hz
{
    SetGain(ZONE_2_GAIN);  // 0.2
}
// ZONE 4: 심각 부족
else if(IceAdjust.f32IceMakeAvgFlow < GetCCToHz(35))  // < 63Hz
{
    SetGain(ZONE_4_GAIN);  // 0.7
}
// ZONE 3: 살짝 부족
else if(IceAdjust.f32IceMakeAvgFlow < GetCCToHz(50))  // < 90Hz
{
    SetGain(ZONE_3_GAIN);  // 0.2
}
// ZONE 5: 정상 범위
else  // 50~75ml (90~135Hz)
{
    SetGain(ZONE_5_GAIN);  // 0.05
}
```

**물리적 의미:**
- **목표: 70ml 제빙** (총 200ml 입수 가정 시 130ml 배수)
- **120ml 이상**: 너무 많이 얼었음 → 제빙시간 대폭 감소 필요
- **35ml 이하**: 거의 안 얼었음 → 제빙시간 대폭 증가 필요
- **50~75ml**: 거의 맞음 → 미세 조정만

---

### 🔹 STEP 4: 이론 비율 계산 및 다음 제빙시간 결정 (라인 141-143)

```c
SetTheoryRatio(IceAdjust.f32IceMakeAvgFlow);
SetNextIceMakeTime((U16)(GetThisTimeIceMakeTime() * GetRatio()));
```

#### 4-1. SetTheoryRatio() 함수 분석 (라인 171-210)

**핵심 수식:**
```c
mf32_target = (F32)GetCCToHz(ICE_V_TARGET);  // 70ml → 126Hz
mf32_ratio_theory = (mf32_target / mf32_avg);

mf32_eff_ratio = SetValidGain() * GetGain();
mf32_final_ratio = 1.0F + (mf32_eff_ratio * (mf32_ratio_theory - 1.0F));
```

**단계별 계산 예시:**
- **현재 평균: 100ml (180Hz)**
- **목표: 70ml (126Hz)**

1. **이론 비율:**
   ```
   ratio_theory = 126 / 180 = 0.7
   ```
   → 제빙시간을 0.7배로 줄여야 함 (30% 감소)

2. **유효 게인 (센서 신뢰도 반영):**
   ```c
   F32 SetValidGain(void)
   {
       // 배수유량 > 입수유량 × 1.05 → INVALID (0)
       if(DrainFlow.f32IceMakeAfterFlowHz > (U16)(DrainFlow.f32IceMakeBeforeFlowHz * 1.05))
           return INVALID;  // 0

       // 배수 > 입수 또는 차이 > 80cc → SUSPECT (0.3)
       else if((DrainFlow.f32IceMakeAfterFlowHz > DrainFlow.f32IceMakeBeforeFlowHz)
           || (mf32_diff > (F32)GetCCToHz(80)))
           return SUSPECT;  // 0.3

       // 정상
       else
           return VALID;  // 1.0
   }
   ```
   - **VALID (1.0)**: 센서 데이터 100% 신뢰
   - **SUSPECT (0.3)**: 30%만 반영 (의심스러움)
   - **INVALID (0)**: 보정 안 함 (센서 오류)

3. **유효 비율 계산:**
   ```
   eff_ratio = 1.0 (VALID) × 0.7 (ZONE_1_GAIN) = 0.7
   ```

4. **최종 비율:**
   ```
   final_ratio = 1.0 + (0.7 × (0.7 - 1.0))
               = 1.0 + (0.7 × -0.3)
               = 1.0 - 0.21
               = 0.79
   ```

5. **다음 제빙시간:**
   ```
   NextTime = ThisTime × 0.79
   ```
   - 현재 시간이 10,000초면 → 다음은 7,900초

---

### 🔹 STEP 5: 상한/하한 제한 (라인 145-153)

```c
if(GetNextIceMakeTime() < ICE_MAKE_TIME_MIN)  // 2000초 (33분)
{
    SetNextIceMakeTime(ICE_MAKE_TIME_MIN);
}
else if(GetNextIceMakeTime() > ICE_MAKE_TIME_MAX)  // 21000초 (350분)
{
    SetNextIceMakeTime(ICE_MAKE_TIME_MAX);
}
```

**안전 장치:**
- **최소 2000초 (33분)**: 너무 짧으면 압축기 과부하
- **최대 21000초 (350분)**: 너무 길면 제빙 포기 상태

---

### 🔹 STEP 6: 변화량 제한 (안정화) (라인 155-163)

```c
if((GetNextIceMakeTime() > mu16DeltaTimeLimit + GetThisTimeIceMakeTime()))
{
    SetNextIceMakeTime((GetThisTimeIceMakeTime() + mu16DeltaTimeLimit));
}
else if((GetNextIceMakeTime() < GetThisTimeIceMakeTime() - mu16DeltaTimeLimit))
{
    SetNextIceMakeTime((GetThisTimeIceMakeTime() - mu16DeltaTimeLimit));
}
```

**예시:**
- **현재 시간: 10,000초**
- **계산된 다음 시간: 15,000초 (5,000초 증가)**
- **제한: ±600초**
- **실제 적용: 10,600초** (600초만 증가)

**이유:** 급격한 변화는 시스템 진동(oscillation)을 유발할 수 있으므로 점진적 조정

---

### 📊 전체 제어 흐름 다이어그램

```
[제빙 완료]
    ↓
[GetDrainFlow() 측정] → 제빙 전후 유량 차이 계산
    ↓
[FIFO 평균 계산] → 최근 3회 이동 평균
    ↓
[ZONE 판정] → 5개 구간으로 분류, GAIN 설정
    ↓
[이론 비율 계산] → 목표/현재 비율
    ↓
[센서 신뢰도 검증] → VALID/SUSPECT/INVALID
    ↓
[최종 비율 계산] → 1.0 + (유효게인 × (이론비율 - 1.0))
    ↓
[다음 시간 계산] → 현재시간 × 최종비율
    ↓
[상한/하한 제한] → 2000~21000초
    ↓
[변화량 제한] → ±600초/회
    ↓
[다음 제빙에 적용]
```

---

### 🎯 핵심 알고리즘 정리

#### 1. PID 제어의 P(비례) 요소
- **ZONE 1~5의 GAIN 값**이 비례 계수 역할
- 오차가 클수록 큰 보정 (0.7), 작을수록 작은 보정 (0.05)

#### 2. 이동 평균 필터
- 노이즈 제거 및 안정화
- 최근 3회 데이터만 사용

#### 3. 센서 신뢰도 기반 적응 제어
- `SetValidGain()`으로 센서 데이터 품질 평가
- 의심스러운 데이터는 반영률 감소

#### 4. 다중 안전 장치
- 상한/하한 제한
- 1회 변화량 제한
- 센서 유효성 검사

---

### ⚠️ 주의사항 및 개선 가능 포인트

#### 1. 잠재적 문제점

1. **초기 수렴 시간이 김**
   - 3회까지는 충분한 데이터 없음
   - 초기값 설정이 중요

2. **ZONE 경계에서 떨림 현상 가능**
   - 75ml 근처에서 ZONE 2 ↔ ZONE 5 진동
   - 히스테리시스(Hysteresis) 추가 권장

3. **센서 오류 시 복구 메커니즘 부족**
   - INVALID 상태가 지속되면 보정 불가

#### 2. 개선 제안

1. **ZONE 경계에 히스테리시스 추가**
   ```c
   // 예: ZONE 2 → ZONE 5 전환 시 70ml, ZONE 5 → ZONE 2 전환 시 78ml
   ```

2. **적분(I) 요소 추가**
   - 누적 오차 보정으로 정상 상태 오차 제거

3. **미분(D) 요소 추가**
   - 급격한 변화에 대한 예측 제어

---

## 2. 이론 비율(Theory Ratio) 수식

`SetTheoryRatio()` 함수의 수식을 단계별로 정리합니다.

### 📐 기본 수식 구조

#### 1단계: 이론 비율 (Theory Ratio)

```
ratio_theory = Target / Average
```

**의미:**
- `Target` = 목표 제빙량 (70ml = 126Hz)
- `Average` = 실제 측정된 평균 제빙량 (Hz 단위)
- 현재 시간 대비 **필요한 변화 비율**

**예시:**
- 실제 100ml 제빙됨 → `ratio_theory = 70/100 = 0.7` → 시간을 70%로 줄여야 함
- 실제 50ml 제빙됨 → `ratio_theory = 70/50 = 1.4` → 시간을 140%로 늘려야 함

---

#### 2단계: 유효 게인 (Effective Gain)

```
eff_gain = ValidGain × ZoneGain
```

**의미:**
- `ValidGain` = 센서 신뢰도 (0, 0.3, 1.0)
- `ZoneGain` = ZONE별 보정 강도 (0.05, 0.2, 0.7)
- 실제로 **반영할 보정의 강도**

**예시:**
- VALID(1.0) × ZONE_1(0.7) = 0.7 → 70% 반영
- SUSPECT(0.3) × ZONE_1(0.7) = 0.21 → 21%만 반영
- INVALID(0) × ZONE_1(0.7) = 0 → 반영 안 함

---

#### 3단계: 최종 비율 (Final Ratio)

```
final_ratio = 1.0 + eff_gain × (ratio_theory - 1.0)
```

**전개하면:**
```
final_ratio = 1.0 + eff_gain × ratio_theory - eff_gain
            = 1.0 - eff_gain + eff_gain × ratio_theory
            = (1 - eff_gain) + eff_gain × ratio_theory
```

**의미:**
- `ratio_theory - 1.0` = 이론적 변화량 (오차)
- `eff_gain × (ratio_theory - 1.0)` = 실제 적용할 변화량
- 현재 시간(1.0)에서 **조금씩 보정**

---

### 🧮 수식의 물리적 의미

#### 케이스 1: 과제빙 (100ml 제빙됨)

```
Target = 70ml (126Hz)
Average = 100ml (180Hz)

ratio_theory = 70/100 = 0.7
eff_gain = 1.0 × 0.7 = 0.7 (VALID, ZONE_1)

final_ratio = 1.0 + 0.7 × (0.7 - 1.0)
            = 1.0 + 0.7 × (-0.3)
            = 1.0 - 0.21
            = 0.79

Next Time = Current Time × 0.79 (21% 감소)
```

**해석:** 30% 줄여야 하지만, 70% 강도로 보정 → 실제 21% 감소

---

#### 케이스 2: 부족제빙 (40ml 제빙됨)

```
Target = 70ml (126Hz)
Average = 40ml (72Hz)

ratio_theory = 70/40 = 1.75
eff_gain = 1.0 × 0.7 = 0.7 (VALID, ZONE_4)

final_ratio = 1.0 + 0.7 × (1.75 - 1.0)
            = 1.0 + 0.7 × 0.75
            = 1.0 + 0.525
            = 1.525

Next Time = Current Time × 1.525 (52.5% 증가)
```

**해석:** 75% 늘려야 하지만, 70% 강도로 보정 → 실제 52.5% 증가

---

#### 케이스 3: 거의 정상 (65ml 제빙됨)

```
Target = 70ml (126Hz)
Average = 65ml (117Hz)

ratio_theory = 70/65 = 1.077
eff_gain = 1.0 × 0.05 = 0.05 (VALID, ZONE_5)

final_ratio = 1.0 + 0.05 × (1.077 - 1.0)
            = 1.0 + 0.05 × 0.077
            = 1.0 + 0.00385
            = 1.00385

Next Time = Current Time × 1.00385 (0.385% 증가)
```

**해석:** 7.7% 늘려야 하지만, 5% 강도로 보정 → 실제 0.385% 미세 조정

---

#### 케이스 4: 센서 의심 (100ml 제빙, 센서 불안정)

```
Target = 70ml (126Hz)
Average = 100ml (180Hz)

ratio_theory = 70/100 = 0.7
eff_gain = 0.3 × 0.7 = 0.21 (SUSPECT, ZONE_1)

final_ratio = 1.0 + 0.21 × (0.7 - 1.0)
            = 1.0 + 0.21 × (-0.3)
            = 1.0 - 0.063
            = 0.937

Next Time = Current Time × 0.937 (6.3% 감소)
```

**해석:** 30% 줄여야 하지만, 센서 불안정으로 21% 강도 → 실제 6.3%만 감소

---

### 📊 수식 시각화

```
           이론적 변화량
                ↓
    ┌───────────────────────────┐
    │  (ratio_theory - 1.0)     │  ← 목표/평균 - 1
    └───────────┬───────────────┘
                │
                × (곱하기)
                │
    ┌───────────┴───────────────┐
    │     eff_gain              │  ← 센서신뢰도 × ZONE게인
    └───────────┬───────────────┘
                │
                ↓
         실제 적용 변화량
                │
                +
                │
    ┌───────────┴───────────────┐
    │         1.0               │  ← 현재 시간 기준
    └───────────┬───────────────┘
                │
                ↓
          final_ratio
                │
                × (곱하기)
                │
    ┌───────────┴───────────────┐
    │   Current Ice Time        │
    └───────────┬───────────────┘
                │
                ↓
         Next Ice Time
```

---

### 🎯 핵심 포인트

#### 1. 비례 제어 (Proportional Control)
```
Δ = eff_gain × (Target/Average - 1)
```
- 오차가 클수록 큰 보정
- 오차가 작을수록 작은 보정

#### 2. 안전 계수 (Safety Factor)
```
eff_gain = ValidGain × ZoneGain
```
- 최대 0.7 (70%) 보정 → 30%는 여유분
- 센서 불안정 시 자동 감쇄

#### 3. 점진적 수렴 (Gradual Convergence)
```
final_ratio = 1.0 + eff_gain × error
```
- 한 번에 목표 도달 안 함
- 여러 회에 걸쳐 점진적 접근

---

### 📝 수식 요약표

| **변수** | **수식** | **범위** | **의미** |
|---------|---------|---------|---------|
| `ratio_theory` | `Target / Average` | 0.5 ~ 2.0 | 이론적 필요 비율 |
| `ValidGain` | 센서 검증 결과 | 0, 0.3, 1.0 | 센서 신뢰도 |
| `ZoneGain` | ZONE별 설정 | 0.05 ~ 0.7 | 보정 강도 |
| `eff_gain` | `ValidGain × ZoneGain` | 0 ~ 0.7 | 실제 반영 계수 |
| `final_ratio` | `1.0 + eff_gain × (ratio_theory - 1.0)` | 0.79 ~ 1.525 | 최종 시간 비율 |

---

## 3. 제빙 STATE 흐름표

### 📋 메인 제빙 프로세스 (ICE_STEP)

| **STATE** | **값** | **이름** | **주요 동작** | **다음 STATE 조건** | **비고** |
|-----------|--------|---------|-------------|-------------------|---------|
| **STATE_0_STANDBY** | 0 | 대기 상태 | - 압축기 OFF 지연 확인<br>- 제빙 조건 확인 | - 압축기 준비 완료 시<br>→ STATE_5 (예열) 또는<br>→ STATE_10 (트레이 상승) | 외기온 25℃ 미만 시 예열 진행 |
| **STATE_5_PREHEAT_HOTGAS_MOVE** | 5 | 예열 가스스위치 이동 | - 가스스위치를 HOT GAS로 전환 | → STATE_6 | 저온 환경 대응 |
| **STATE_6_CALC_PREHEAT_TIME** | 6 | 예열 시간 계산 | - 가스스위치 위치 확인<br>- 압축기 RPS 설정 (60Hz)<br>- 예열 시간 계산 | - 가스스위치 완료 시<br>→ STATE_7 | 외기온별 예열 시간 결정 |
| **STATE_7_PREHEAT_OPERATION** | 7 | 예열 동작 | - 예열 타이머 카운트다운<br>- 압축기 동작 확인 | - 예열 완료 시<br>→ STATE_10 | 360~600초 예열 |
| **STATE_10_ICE_TRAY_MOVE_UP** | 10 | 트레이 상승 | - 트레이 모터 상승 시작<br>- F_CristalIce = SET | - 트레이 상승 완료 대기<br>→ STATE_11 | 제빙 위치로 이동 |
| **STATE_11_WAIT_ROOM_WATER_FULL** | 11 | 트레이 위치 확인 | - 트레이 상승 완료 확인<br>- LEV 센서 확인 | - 압축기 동작 중<br>→ STATE_12<br>- 압축기 OFF<br>→ STATE_14 | ICE_TRAY_POSITION_ICE_MAKING |
| **STATE_12_CONT_ICE_SWITCH_MOVE** | 12 | 연속 가스스위치 이동 | - 가스스위치를 ICE로 전환 | → STATE_13 | 압축기 이미 동작 중일 때 |
| **STATE_13_CONT_RPS_SETTING** | 13 | 연속 RPS 설정 | - 가스스위치 위치 확인<br>- 압축기 RPS 설정 (65~66Hz) | - 가스스위치 완료 시<br>→ STATE_14 | 외기온별 RPS 조정 |
| **STATE_14_CHECK_ICE_TRAY_HZ** | 14 | 유량센서 초기화 | - 입수 유량 초기화 (200cc - 400 보정)<br>- 배수 유량 0으로 초기화 | - 물추출 없을 시<br>→ STATE_20 | **기술과제 관련** 유량센서 준비 |
| **STATE_20_WATER_IN_ICE_TRAY** | 20 | 트레이 물 투입 | - 트레이에 물 투입 (200cc)<br>- 유량 카운트 감소 | - 물 투입 완료 시<br>→ STATE_21<br>- 에러 발생 시<br>→ STATE_40/51 | 제빙수 공급 |
| **STATE_21_ICE_SWITCH_MOVE** | 21 | 가스스위치 ICE로 전환 | - 가스스위치를 ICE로 전환<br>- 타이머 초기화 | → STATE_22 | 제빙 모드 준비 |
| **STATE_22_WAIT_ICE_MAKING_TIME** | 22 | 제빙 시작 대기 | - 10초 대기 (안정화) | - 10초 경과 후<br>→ STATE_30 | 제빙 시작 전 안정화 시간 |
| **STATE_30_CALC_ICE_MAKING_TIME** | 30 | 제빙 시간 계산 | - 제빙테이블 사용 여부 확인<br>- 외기온/입수온 기반 시간 계산<br>- 얼음 크기 보정 (대/소)<br>- **보정된 시간 적용**<br>- ThisTimeIceMakeTime 설정 | - 압축기 준비 완료 시<br>→ STATE_31 | **기술과제 핵심**<br>GetNextIceMakeTime() 반영 |
| **STATE_31_MAIN_ICE_MAKING** | 31 | 메인 제빙 동작 | - 제빙 타이머 카운트다운<br>- 압축기 동작 확인<br>- 트레이 위치 복구 (10초마다)<br>- Hot Gas 소음 감소 | - 제빙 완료 시<br>→ **STATE_32** | **기존: STATE_40으로 바로 이동**<br>**변경: STATE_32 추가** |
| **🆕 STATE_32_DRAIN_EMPTY** | 32 | 드레인탱크 비우기 | - 제빙 완료 후 드레인탱크 비우기<br>- 트레이 내리기 **전** 대기 | - 드레인탱크 비어있음<br>→ STATE_40 (트레이 하강) | **[기술과제 추가]**<br>순수 제빙물량 측정 준비 |
| **STATE_40_ICE_TRAY_MOVE_DOWN** | 40 | 트레이 하강 | - 트레이 모터 하강 시작 | - 트레이 하강 완료 시<br>→ **STATE_41** | ICE_TRAY_POSITION_ICE_THROW |
| **🆕 STATE_41_DRAIN_FLOW_CALCUATE** | 41 | 배수 유량 계산 | - 트레이에서 배수되는 물량 측정<br>- 유량센서 카운트 | - 드레인탱크 비어있음<br>→ STATE_42 | **[기술과제 추가]**<br>남은 물량 측정 |
| **🆕 STATE_42_NEXT_ICE_AMOUNT_CAL** | 42 | 다음 제빙시간 계산 | - **SetDrainPrevFlowHz()**<br>- **SetDrainCurFlowHz()**<br>- **ProcessIceMaking()** 호출 | → STATE_43 | **[기술과제 핵심]**<br>다음 제빙시간 보정 |
| **STATE_43_GAS_SWITCH_HOT_GAS** | 43 | Hot Gas 전환 | - 압축기 RPS 설정 (43~50Hz)<br>- 가스스위치 HOT GAS로 전환 | → STATE_44 | 얼음 탈빙 준비 |
| **STATE_44_CALC_HOT_GAS_TIME** | 44 | Hot Gas 시간 계산 | - 가스스위치 위치 확인<br>- Hot Gas 시간 계산 | - 가스스위치 완료 시<br>→ STATE_45 | 외기온별 탈빙 시간 결정<br>(15~765초) |
| **STATE_45_ICE_TAKE_OFF** | 45 | 얼음 탈빙 | - Hot Gas 타이머 카운트다운<br>- 얼음 떨어뜨리기 | - Hot Gas 완료 시<br>→ STATE_46 | 압축기 고온 가스로 탈빙 |
| **STATE_46_FEEDER_OPERATION** | 46 | 피더 동작 | - 얼음 믹싱<br>- 피더 모터 동작 | - 믹싱 완료 시<br>→ STATE_50 | 얼음 골고루 섞기 |
| **STATE_50_ICE_FULL_IR_CHECK** | 50 | 얼음통 만빙 확인 | - IR 센서로 얼음통 확인 | - 만빙 아님<br>→ STATE_51 | F_IR 센서 체크 |
| **STATE_51_FINISH_ICE_MAKE** | 51 | 제빙 완료 | - F_CristalIce = CLEAR<br>- 제빙 사이클 종료 | → STATE_0 | 다음 제빙 대기 |

---

### 🎯 기술과제 추가 STATE 상세 설명

#### STATE_32: DRAIN_EMPTY (드레인탱크 비우기)

```c
case STATE_32_DRAIN_EMPTY:
    if(u8DrainWaterLevel == DRAIN_LEVEL_EMPTY)
    {
        down_tray_motor();
        gu8IceStep = STATE_40_ICE_TRAY_MOVE_DOWN;
    }
```

**목적:** 제빙 완료 직후 트레이를 내리기 **전**에 드레인탱크를 비워서, 순수하게 **이번 제빙에서 버려진 물량만** 측정할 수 있도록 함

**왜 필요한가?**
- 기존: 트레이 내리면서 바로 물이 배수됨 → 이전 배수량과 섞임
- 변경: 트레이 내리기 전 드레인 비움 → 순수 이번 제빙 배수량만 측정

---

#### STATE_41: DRAIN_FLOW_CALCUATE (배수 유량 계산)

```c
case STATE_41_DRAIN_FLOW_CALCUATE:
    // DrainFlowInput() 인터럽트로 f32IceMakeAfterFlowHz 증가
    if(u8DrainWaterLevel == DRAIN_LEVEL_EMPTY)
    {
        gu8IceStep = STATE_42_NEXT_ICE_AMOUNT_CAL;
    }
```

**목적:** 트레이에서 배수되는 물의 유량을 실시간으로 측정

**측정값:**
- `DrainFlow.f32IceMakeAfterFlowHz`: 제빙 후 배수된 물량 (Hz 단위)
- 유량센서 인터럽트로 자동 증가

---

#### STATE_42: NEXT_ICE_AMOUNT_CAL (다음 제빙시간 계산)

```c
case STATE_42_NEXT_ICE_AMOUNT_CAL:
    SetDrainPrevFlowHz(GetDrainCurFlowHz());    // 이전 유량 업데이트
    SetDrainCurFlowHz(GetDrainFlow());          // 현재 유량 계산
    ProcessIceMaking();                          // 다음 제빙시간 보정
    gu8IceStep = STATE_43_GAS_SWITCH_HOT_GAS;
```

**핵심 동작:**
1. **이전 유량 저장**: 센서 신뢰도 검증용
2. **현재 유량 계산**: `입수량 - 배수량 = 실제 제빙 사용량`
3. **ProcessIceMaking() 호출**:
   - FIFO 평균 계산
   - ZONE 판정
   - 이론 비율 계산
   - **NextIceMakeTime 결정**

**결과물:**
- `GetNextIceMakeTime()`: 다음 제빙에 적용될 시간
- 다음 제빙 시 **STATE_30**에서 자동으로 반영됨

---

### 🔄 제빙 STATE 흐름도

```
[STATE_0: STANDBY]
        ↓
    외기온 확인
        ↓
   ┌────┴────┐
   │ < 25℃? │
   └────┬────┘
 YES ←─┘  └─→ NO
   ↓            ↓
[STATE_5~7]  [STATE_10]
  예열 동작    트레이 상승
   ↓            ↓
   └─→ [STATE_11~14]
       트레이 위치 확인
       유량센서 초기화
            ↓
       [STATE_20~21]
       물 투입 (200cc)
            ↓
       [STATE_22]
       10초 안정화 대기
            ↓
       [STATE_30] ⟵━━━━━━━━━━┓
       제빙시간 계산          ┃
       (보정값 적용)          ┃ NextIceMakeTime
            ↓                 ┃ 반영됨
       [STATE_31]            ┃
       메인 제빙 동작         ┃
       (8~13분)              ┃
            ↓                 ┃
  🆕 [STATE_32]             ┃
     드레인탱크 비우기       ┃
            ↓                 ┃
       [STATE_40]            ┃
       트레이 하강            ┃
            ↓                 ┃
  🆕 [STATE_41]             ┃
     배수 유량 측정          ┃
            ↓                 ┃
  🆕 [STATE_42] ━━━━━━━━━━━┛
     다음 제빙시간 계산
     (ProcessIceMaking)
            ↓
       [STATE_43~45]
       Hot Gas 탈빙
            ↓
       [STATE_46]
       피더 믹싱
            ↓
       [STATE_50~51]
       만빙 확인 / 완료
            ↓
       [STATE_0]
```

---

### 📊 STATE 카테고리별 분류

| **카테고리** | **STATE 범위** | **주요 기능** |
|-------------|--------------|-------------|
| **대기/초기화** | 0, 5~7 | 대기, 예열 |
| **준비** | 10~14 | 트레이 상승, 센서 초기화 |
| **물 투입** | 20~22 | 제빙수 투입, 안정화 |
| **제빙** | 30~32 | 시간 계산, 메인 제빙, **드레인 비우기** |
| **측정/보정** | 40~42 | 트레이 하강, **유량 측정**, **보정 계산** |
| **탈빙** | 43~46 | Hot Gas, 피더 동작 |
| **완료** | 50~51 | 만빙 확인, 종료 |

---

## 4. 기술과제 핵심 요약

### 🎯 목표
**제빙량을 실시간으로 측정하여 다음 제빙시간을 자동으로 조정**함으로써, 항상 **70ml의 최적 얼음**을 생산

### 📝 구현 방법

#### 1. 유량 측정 시스템
- **입수 유량**: 제빙 시작 전 (STATE_14)
- **배수 유량**: 트레이 하강 후 (STATE_41)
- **실제 제빙량** = 입수 유량 - 배수 유량

#### 2. 적응형 제어 알고리즘
- **FIFO 이동 평균**: 최근 3회 데이터 사용
- **5개 ZONE**: 오차 크기별 보정 강도 조정
- **센서 신뢰도 검증**: 의심스러운 데이터 필터링
- **다중 안전 장치**: 상한/하한, 변화량 제한

#### 3. STATE 흐름 변경

**기존:**
```
STATE_31 (제빙) → STATE_40 (트레이 하강) → STATE_43 (탈빙)
```

**변경:**
```
STATE_31 (제빙) → STATE_32 (드레인 비우기) → STATE_40 (트레이 하강)
→ STATE_41 (유량 측정) → STATE_42 (보정 계산) → STATE_43 (탈빙)
```

### 🔬 핵심 함수

1. **`ProcessIceMaking()`** (work_ice_make.c)
   - 평균 계산, ZONE 판정, 비율 계산
   - NextIceMakeTime 결정

2. **`SetTheoryRatio()`** (work_ice_make.c)
   - 이론 비율 계산
   - 센서 신뢰도 반영

3. **`GetDrainFlow()`** (work_flow.c)
   - 실제 제빙량 계산
   - 입수 - 배수

4. **`SetValidGain()`** (work_flow.c)
   - 센서 데이터 신뢰도 검증
   - VALID/SUSPECT/INVALID

### 📈 기대 효과

1. **품질 향상**: 항상 일정한 크기의 얼음 생산
2. **에너지 절감**: 과제빙 방지로 전력 소비 감소
3. **자동 적응**: 환경 변화에 자동 대응
4. **안정성**: 다중 안전 장치로 시스템 보호

---

## 참고 자료

### 주요 파일
- `Source/Ice_Mini/work_ice_make.c` - 제빙시간 보정 알고리즘
- `Source/Ice_Mini/work_ice_make.h` - 상수 정의 (ZONE GAIN, 목표값 등)
- `Source/Ice_Mini/work_flow.c` - 유량 측정 및 센서 신뢰도
- `Source/Ice_Mini/M8_Ice_Making.c` - 제빙 STATE 머신

### 주요 상수
```c
#define ICE_V_TARGET         63           // 목표 얼음량 70ml
#define ICE_MAKE_TIME_MIN    2000         // 최소 제빙시간 (33분)
#define ICE_MAKE_TIME_MAX    21000        // 최대 제빙시간 (350분)
#define C_ICE_MAKING         1.8F         // CC → Hz 변환 계수

#define ZONE_1_GAIN          0.7F         // 심각 과제빙
#define ZONE_2_GAIN          0.2F         // 살짝 과제빙
#define ZONE_3_GAIN          0.2F         // 살짝 부족
#define ZONE_4_GAIN          0.7F         // 심각 부족
#define ZONE_5_GAIN          0.05F        // 정상 범위

#define VALID                1.0F         // 센서 정상
#define SUSPECT              0.3F         // 센서 의심
#define INVALID              0            // 센서 오류
```

---

**문서 끝**

